# ğŸ—„ï¸ æ•°æ®åº“å­—æ®µåˆ†ææŠ¥å‘Š

## ğŸ“… åˆ†ææ—¶é—´
**2025å¹´6æœˆ21æ—¥ - å®Œæ•´æ•°æ®åº“å­—æ®µä½¿ç”¨æƒ…å†µåˆ†æ**

## ğŸ“Š å­—æ®µä½¿ç”¨æƒ…å†µåˆ†æ

### 1. **Userè¡¨å­—æ®µåˆ†æ**

| å­—æ®µå | ç±»å‹ | æ˜¯å¦ä½¿ç”¨ | ä½¿ç”¨é¢‘ç‡ | å»ºè®® |
|--------|------|----------|----------|------|
| `id` | String | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (ä¸»é”®) |
| `clerkUserId` | String | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (è®¤è¯å¿…éœ€) |
| `email` | String | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (æ”¯ä»˜åŒ¹é…) |
| `googleFullName` | String? | âœ… æœ‰ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (ç”¨æˆ·åŒæ­¥) |
| `googleImageUrl` | String? | âŒ æœªä½¿ç”¨ | æ—  | ğŸŸ¡ è€ƒè™‘åˆ é™¤ |
| `googleVerifiedAt` | DateTime | âœ… æœ‰ä½¿ç”¨ | ä½ | ğŸŸ¢ ä¿ç•™ (å®¡è®¡) |
| `customDisplayName` | String? | âŒ æœªä½¿ç”¨ | æ—  | ğŸŸ¡ è€ƒè™‘åˆ é™¤ |
| `isActive` | Boolean | âœ… æœ‰ä½¿ç”¨ | ä½ | ğŸŸ¢ ä¿ç•™ (ç”¨æˆ·ç®¡ç†) |
| `preferences` | Json? | âŒ æœªä½¿ç”¨ | æ—  | ğŸ”´ å»ºè®®åˆ é™¤ |
| `createdAt` | DateTime | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (å®¡è®¡) |
| `updatedAt` | DateTime | âœ… è‡ªåŠ¨æ›´æ–° | ä¸­ | ğŸŸ¢ ä¿ç•™ (å®¡è®¡) |
| `lastLoginAt` | DateTime | âœ… æœ‰ä½¿ç”¨ | ä½ | ğŸŸ¢ ä¿ç•™ (ç”¨æˆ·æ´»è·ƒåº¦) |
| `totalCredits` | Int | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (ç§¯åˆ†ç³»ç»Ÿ) |
| `usedCredits` | Int | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (ç§¯åˆ†ç³»ç»Ÿ) |

### 2. **Videoè¡¨å­—æ®µåˆ†æ**

| å­—æ®µå | ç±»å‹ | æ˜¯å¦ä½¿ç”¨ | ä½¿ç”¨é¢‘ç‡ | å»ºè®® |
|--------|------|----------|----------|------|
| `id` | String | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (ä¸»é”®) |
| `userId` | String | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (å…³è”ç”¨æˆ·) |
| `userEmail` | String? | âš ï¸ éƒ¨åˆ†ä½¿ç”¨ | ä½ | ğŸŸ¡ å†—ä½™å­—æ®µ |
| `taskId` | String? | âœ… æ–°å¢é‡è¦ | é«˜ | ğŸŸ¢ ä¿ç•™ (kie.aiæ˜ å°„) |
| `title` | String | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (æ˜¾ç¤º) |
| `type` | String | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (åˆ†ç±») |
| `prompt` | String | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (å†å²è®°å½•) |
| `status` | String | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (çŠ¶æ€ç®¡ç†) |
| `videoUrl` | String? | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (720pè§†é¢‘) |
| `videoUrl1080p` | String? | âœ… æ–°å¢é‡è¦ | é«˜ | ğŸŸ¢ ä¿ç•™ (é«˜æ¸…è§†é¢‘) |
| `thumbnailUrl` | String? | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (é¢„è§ˆ) |
| `duration` | Int? | âŒ è¯»å–ä½†ä¸å­˜å‚¨ | ä½ | ğŸŸ¡ è€ƒè™‘åˆ é™¤ |
| `resolution` | String? | âŒ æœªå®é™…ä½¿ç”¨ | æ—  | ğŸ”´ å»ºè®®åˆ é™¤ |
| `creditsUsed` | Int | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (ç§¯åˆ†ç»Ÿè®¡) |
| `createdAt` | DateTime | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (æ’åº) |
| `updatedAt` | DateTime | âœ… è‡ªåŠ¨æ›´æ–° | ä¸­ | ğŸŸ¢ ä¿ç•™ (å®¡è®¡) |
| `completedAt` | DateTime? | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (ç»Ÿè®¡) |

### 3. **Purchaseè¡¨å­—æ®µåˆ†æ**

| å­—æ®µå | ç±»å‹ | æ˜¯å¦ä½¿ç”¨ | ä½¿ç”¨é¢‘ç‡ | å»ºè®® |
|--------|------|----------|----------|------|
| `id` | String | âœ… ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (ä¸»é”®) |
| `userId` | String? | âœ… é¢‘ç¹ä½¿ç”¨ | é«˜ | ğŸŸ¢ ä¿ç•™ (å…³è”ç”¨æˆ·) |
| `packageType` | String | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (åˆ†ç±») |
| `packageName` | String | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (æ˜¾ç¤º) |
| `amount` | Float | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (é‡‘é¢) |
| `currency` | String | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (è´§å¸) |
| `creditsAdded` | Int | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (ç§¯åˆ†) |
| `productId` | String? | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (äº§å“æ˜ å°„) |
| `orderId` | String? | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (è®¢å•è¿½è¸ª) |
| `customerId` | String? | âš ï¸ éƒ¨åˆ†ä½¿ç”¨ | ä½ | ğŸŸ¡ ä¿ç•™å¤‡ç”¨ |
| `provider` | String | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (æ”¯ä»˜å•†) |
| `status` | String | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (çŠ¶æ€) |
| `createdAt` | DateTime | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (æ—¶é—´) |
| `completedAt` | DateTime | âœ… ä½¿ç”¨ | ä¸­ | ğŸŸ¢ ä¿ç•™ (å®Œæˆæ—¶é—´) |
| `paymentEmail` | String? | âš ï¸ å­˜å‚¨ä½†è¾ƒå°‘ä½¿ç”¨ | ä½ | ğŸŸ¡ ä¿ç•™å¤‡ç”¨ |

## ğŸ”„ å­—æ®µäº¤äº’åˆ†æ

### âœ… **æ­£å¸¸äº¤äº’çš„å­—æ®µ**

1. **ç”¨æˆ·è®¤è¯é“¾**
   ```
   User.clerkUserId â†” Clerkè®¤è¯ç³»ç»Ÿ
   User.email â†” Purchase.paymentEmail (æ”¯ä»˜åŒ¹é…)
   User.id â†” Video.userId (è§†é¢‘å…³è”)
   User.id â†” Purchase.userId (è´­ä¹°å…³è”)
   ```

2. **ç§¯åˆ†ç³»ç»Ÿé“¾**
   ```
   User.totalCredits â† Purchase.creditsAdded (è´­ä¹°å¢åŠ )
   User.usedCredits â† Video.creditsUsed (æ¶ˆè€—æ‰£é™¤)
   remainingCredits = totalCredits - usedCredits (è®¡ç®—å‰©ä½™)
   ```

3. **è§†é¢‘ç”Ÿæˆé“¾**
   ```
   Video.taskId â†” kie.ai API (å¤–éƒ¨æ˜ å°„)
   Video.status â†” kie.aiçŠ¶æ€ (å®æ—¶åŒæ­¥)
   Video.videoUrl â†” 720pä¸‹è½½é“¾æ¥
   Video.videoUrl1080p â†” 1080pä¸‹è½½é“¾æ¥
   ```

### âš ï¸ **å†—ä½™/é—®é¢˜å­—æ®µ**

1. **Video.userEmail** 
   - **é—®é¢˜**: ä¸User.emailé‡å¤
   - **ç°çŠ¶**: å¯ä»¥é€šè¿‡Video.userId â†’ User.emailè·å–
   - **å»ºè®®**: åˆ é™¤æ­¤å­—æ®µ

2. **Video.resolution**
   - **é—®é¢˜**: é™æ€å­—ç¬¦ä¸²ï¼Œæ— å®é™…ä¸šåŠ¡ä»·å€¼
   - **ç°çŠ¶**: æœªåœ¨APIä¸­ä½¿ç”¨
   - **å»ºè®®**: åˆ é™¤æ­¤å­—æ®µ

3. **Video.duration** 
   - **é—®é¢˜**: å­˜å‚¨Intç±»å‹ï¼Œä½†APIä½¿ç”¨String
   - **ç°çŠ¶**: ä¸åŒæ­¥ï¼Œå®¹æ˜“æ··æ·†
   - **å»ºè®®**: åˆ é™¤æ•°æ®åº“å­—æ®µï¼Œä»…APIä½¿ç”¨

4. **User.preferences**
   - **é—®é¢˜**: Jsonå­—æ®µæœªä½¿ç”¨
   - **ç°çŠ¶**: å®Œå…¨æœªä½¿ç”¨
   - **å»ºè®®**: åˆ é™¤æ­¤å­—æ®µ

## ğŸ› ï¸ ä¼˜åŒ–å»ºè®®

### 1. **ç«‹å³åˆ é™¤çš„å­—æ®µ**
```sql
-- Userè¡¨
ALTER TABLE users DROP COLUMN preferences;

-- Videoè¡¨  
ALTER TABLE videos DROP COLUMN userEmail;
ALTER TABLE videos DROP COLUMN resolution;
ALTER TABLE videos DROP COLUMN duration;
```

### 2. **è€ƒè™‘åˆ é™¤çš„å­—æ®µ**
```sql
-- Userè¡¨ (å¦‚æœä¸éœ€è¦å¤´åƒåŠŸèƒ½)
ALTER TABLE users DROP COLUMN googleImageUrl;

-- Userè¡¨ (å¦‚æœä¸éœ€è¦è‡ªå®šä¹‰æ˜¾ç¤ºå)
ALTER TABLE users DROP COLUMN customDisplayName;
```

### 3. **ä¿ç•™ä½†ç›‘æ§çš„å­—æ®µ**
- `User.googleVerifiedAt` - å®¡è®¡ç”¨é€”
- `User.lastLoginAt` - ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ
- `Purchase.customerId` - æœªæ¥æ”¯ä»˜åŠŸèƒ½æ‰©å±•
- `Purchase.paymentEmail` - æ”¯ä»˜é—®é¢˜æ’æŸ¥

## ğŸ“ˆ æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### å»ºè®®çš„ç´¢å¼•
```sql
-- è§†é¢‘æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_videos_userid_createdat ON videos(userId, createdAt DESC);
CREATE INDEX idx_videos_taskid ON videos(taskId);
CREATE INDEX idx_videos_status ON videos(status);

-- ç”¨æˆ·æŸ¥è¯¢ä¼˜åŒ–  
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_clerkuserid ON users(clerkUserId);

-- è´­ä¹°è®°å½•ä¼˜åŒ–
CREATE INDEX idx_purchases_userid_createdat ON purchases(userId, createdAt DESC);
```

## ğŸ¯ æœ€ç»ˆå»ºè®®

### é«˜ä¼˜å…ˆçº§æ¸…ç†
1. âœ… **åˆ é™¤**: `User.preferences` (å®Œå…¨æœªä½¿ç”¨)
2. âœ… **åˆ é™¤**: `Video.userEmail` (å†—ä½™å­—æ®µ)  
3. âœ… **åˆ é™¤**: `Video.resolution` (æ— ä¸šåŠ¡ä»·å€¼)
4. âœ… **åˆ é™¤**: `Video.duration` (ç±»å‹ä¸åŒ¹é…)

### ä¸­ä¼˜å…ˆçº§æ¸…ç†
1. ğŸŸ¡ **è€ƒè™‘åˆ é™¤**: `User.googleImageUrl` (å¦‚ä¸éœ€è¦å¤´åƒ)
2. ğŸŸ¡ **è€ƒè™‘åˆ é™¤**: `User.customDisplayName` (å¦‚ä¸éœ€è¦è‡ªå®šä¹‰åç§°)

### ä¿ç•™å­—æ®µ
- æ‰€æœ‰ä¸»é”®å’Œå¤–é”®å­—æ®µ
- ç§¯åˆ†ç³»ç»Ÿç›¸å…³å­—æ®µ
- å®¡è®¡å’Œæ—¶é—´æˆ³å­—æ®µ
- è§†é¢‘URLå’ŒçŠ¶æ€å­—æ®µ

**ğŸ“Š æ€»ç»“**: æ•°æ®åº“æ•´ä½“è®¾è®¡åˆç†ï¼Œä¸»è¦äº¤äº’éƒ½æ­£å¸¸å·¥ä½œã€‚å»ºè®®åˆ é™¤4ä¸ªå†—ä½™å­—æ®µä»¥æé«˜æ€§èƒ½å’Œç»´æŠ¤æ€§ã€‚ 