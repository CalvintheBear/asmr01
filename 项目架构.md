# 🏗️ CuttingASMR.org 项目架构文档

**项目名称:** CuttingASMR.org - AI ASMR视频生成平台  
**版本:** v1.0  
**架构设计师:** 系统团队  
**最后更新:** 2025-01-25

---

## 📋 项目概述

CuttingASMR.org 是一个基于AI的ASMR视频生成平台，使用Google Veo3 Fast API为用户提供高质量的ASMR视频内容生成服务。平台采用现代化的全栈架构，支持用户认证、积分购买、视频生成和内容管理。

### 核心功能
- 🤖 AI驱动的ASMR视频生成
- 💳 集成支付系统（Creem）
- 👥 用户认证与管理（Clerk）
- 💎 积分制消费模式
- 📱 响应式Web界面
- 🌍 全球CDN加速

---

## 🎯 技术栈概览

### 前端技术栈
```
├── Next.js 14 (App Router)
├── React 18 (客户端组件)
├── TypeScript (类型安全)
├── TailwindCSS (样式系统)
├── Lucide React (图标库)
└── Progressive Web App (PWA支持)
```

### 后端技术栈
```
├── Next.js API Routes (Edge Runtime)
├── Prisma ORM (数据访问层)
├── PostgreSQL (主数据库)
├── Clerk (认证服务)
└── Railway (数据库托管)
```

### 部署与运维
```
├── Cloudflare Pages (主机服务)
├── Cloudflare CDN (全球分发)
├── Railway (数据库服务)
├── Creem (支付处理)
└── Google Veo3 Fast (AI引擎)
```

---

## 🏛️ 系统架构设计

### 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    Cloudflare Global Network                │
├─────────────────────────────────────────────────────────────┤
│                         CDN Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Static    │  │    Images   │  │    Assets   │         │
│  │   Assets    │  │   Optimize  │  │   Caching   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                  Cloudflare Pages Platform                  │
├─────────────────────────────────────────────────────────────┤
│                    Edge Runtime Layer                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Static     │  │   Dynamic   │  │     API     │         │
│  │  Pages      │  │   Routes    │  │   Routes    │         │
│  │ (17 pages)  │  │ (8 pages)   │  │ (15 APIs)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┼───────────┐
                    ▼           ▼           ▼
        ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
        │    Clerk    │ │   Railway   │ │    Creem    │
        │    Auth     │ │ PostgreSQL  │ │   Payment   │
        │   Service   │ │  Database   │ │   Gateway   │
        └─────────────┘ └─────────────┘ └─────────────┘
                                │
                                ▼
                        ┌─────────────┐
                        │ Google Veo3 │
                        │   Fast API  │
                        │  (AI Engine)│
                        └─────────────┘
```

---

## 💾 数据库架构设计

### 数据模型关系图
```
┌─────────────────┐    1:N    ┌─────────────────┐
│      User       │◄─────────►│    Purchase     │
├─────────────────┤           ├─────────────────┤
│ id (PK)         │           │ id (PK)         │
│ clerkUserId     │           │ userId (FK)     │
│ email           │           │ packageType     │
│ totalCredits    │           │ amount          │
│ usedCredits     │           │ creditsAdded    │
│ isActive        │           │ orderId         │
│ createdAt       │           │ status          │
└─────────────────┘           └─────────────────┘
         │ 1:N                         │
         ▼                             ▼ N:1
┌─────────────────┐           ┌─────────────────┐
│      Video      │           │    AuditLog     │
├─────────────────┤           ├─────────────────┤
│ id (PK)         │           │ id (PK)         │
│ userId (FK)     │           │ userId (FK)     │
│ taskId          │           │ action          │
│ prompt          │           │ details         │
│ status          │           │ ipAddress       │
│ creditsUsed     │           │ timestamp       │
│ downloadUrl     │           └─────────────────┘
│ createdAt       │
└─────────────────┘
```

### 核心表结构说明

#### User 表 (用户核心数据)
- **主键:** `id` (自增ID)
- **外键:** `clerkUserId` (连接Clerk认证)
- **业务字段:** 
  - `totalCredits`: 用户总积分
  - `usedCredits`: 已消费积分  
  - `remainingCredits = totalCredits - usedCredits`

#### Purchase 表 (购买记录)
- **关联:** 多对一关联到User
- **核心字段:** 订单ID、金额、积分数、支付状态
- **用途:** 购买历史查询、财务对账

#### Video 表 (视频生成记录)
- **关联:** 多对一关联到User
- **核心字段:** 任务ID、提示词、状态、下载链接
- **用途:** 生成历史、积分消费记录

#### AuditLog 表 (审计日志)
- **用途:** 系统操作记录、安全审计、故障排查
- **记录:** 用户操作、支付事件、系统错误

---

## 🔧 API架构设计

### API路由结构
```
/api/
├── health                    # 系统健康检查
├── credits                   # 积分查询API  
├── credits-check            # 积分验证API
├── generate-video           # 视频生成API
├── check-creem-config       # 支付配置检查
├── webhook-info             # Webhook信息
├── user/
│   ├── sync                 # 用户数据同步
│   ├── purchases            # 购买历史查询
│   └── videos               # 视频历史查询
├── webhooks/
│   └── creem/               # Creem支付回调
├── payments/
│   └── creem/               # 支付处理
└── test-*                   # 测试API集合
```

### API认证架构
```
Request → Clerk Middleware → Route Handler → Database
   │              │                │              │
   │              ▼                ▼              │
   │        JWT验证           业务逻辑          数据访问
   │              │                │              │
   │              ▼                ▼              ▼
   │        用户身份         积分检查         Prisma ORM
   │              │                │              │
   │              ▼                ▼              ▼
   └────────  权限验证  ←─────  API响应  ←──── PostgreSQL
```

### 关键API设计

#### 用户同步API (`/api/user/sync`)
```typescript
// POST: 创建/更新用户
// GET: 获取用户信息
interface UserSyncResponse {
  success: boolean
  user: {
    id: string
    email: string
    totalCredits: number
    usedCredits: number
    remainingCredits: number
  }
}
```

#### 积分查询API (`/api/credits`)
```typescript
// GET: 实时积分查询
interface CreditsResponse {
  success: boolean
  credits: {
    total: number
    used: number
    remaining: number
    videos: number
  }
}
```

#### 视频生成API (`/api/generate-video`)
```typescript
// POST: 提交视频生成任务
interface GenerateVideoRequest {
  prompt: string
  asmrType: string
}

interface GenerateVideoResponse {
  success: boolean
  taskId: string
  creditsUsed: number
  estimatedTime: string
}
```

---

## 🎨 前端架构设计

### 组件架构层次
```
App Router (Next.js 14)
├── Layout Components
│   ├── RootLayout (/layout.tsx)
│   ├── ClerkProvider (认证包装)
│   └── Metadata (SEO配置)
├── Page Components  
│   ├── HomePage (/)
│   ├── PricingPage (/pricing)
│   ├── ProfilePage (/profile)
│   └── PaymentPages (/payment/*)
├── Feature Components
│   ├── ASMRVideoResult (视频展示)
│   ├── CreemPaymentButton (支付按钮)
│   ├── ImageUploader (图片上传)
│   └── UserAgreementModal (用户协议)
├── Custom Hooks
│   ├── useCredits (积分管理)
│   └── useVideoGeneration (视频生成)
└── Utility Libraries
    ├── Prisma Client (数据访问)
    ├── Creem Config (支付配置)
    └── API Key Pool (密钥管理)
```

### 状态管理策略
- **本地状态:** React useState/useReducer
- **服务器状态:** Next.js API + SWR模式
- **认证状态:** Clerk Provider管理
- **积分状态:** useCredits Hook集中管理

### 响应式设计
- **移动优先:** Tailwind CSS mobile-first approach
- **断点系统:** sm(640px) / md(768px) / lg(1024px) / xl(1280px)
- **组件自适应:** 使用Tailwind响应式类名

---

## 🚀 部署架构设计

### Cloudflare Pages部署流程
```
GitHub Repository
        │
        ▼
┌─────────────────┐
│ GitHub Actions  │ (可选CI/CD)
│   Build Check   │
└─────────────────┘
        │
        ▼
┌─────────────────┐
│ Cloudflare Pages│
│  Auto Deploy    │ ← Git Push触发
└─────────────────┘
        │
        ▼
┌─────────────────┐
│ Build Process   │
│ npm run build   │ → Next.js构建
│ Static Export   │ → 静态文件生成  
│ Edge Functions  │ → API路由处理
└─────────────────┘
        │
        ▼
┌─────────────────┐
│ Global CDN      │
│ Edge Locations  │ → 全球200+节点
│ Cache Strategy  │ → 智能缓存
└─────────────────┘
```

### 环境配置管理
```
Production Environment (cuttingasmr.org)
├── DATABASE_URL=postgresql://railway...
├── CLERK_SECRET_KEY=sk_live_...
├── CREEM_API_KEY=creem_live_...
├── VEO3_API_KEYS=["key1", "key2", "key3"]
└── NEXT_PUBLIC_APP_URL=https://cuttingasmr.org

Development Environment (localhost:3000)  
├── DATABASE_URL=postgresql://dev...
├── CLERK_SECRET_KEY=sk_test_...
├── CREEM_API_KEY=creem_test_...
├── VEO3_API_KEYS=["test_key"]
└── NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

## 🔐 安全架构设计

### 认证与授权流程
```
用户请求 → Clerk Token验证 → 用户身份提取 → 权限检查 → 资源访问
    │              │                │             │            │
    ▼              ▼                ▼             ▼            ▼
  Bearer       JWT解析         clerkUserId    业务权限      数据访问
  Token         与验证            提取          验证         控制
```

### 数据安全措施
- **传输加密:** 全站HTTPS + TLS 1.3
- **存储加密:** Railway PostgreSQL加密
- **API安全:** JWT认证 + 请求限制
- **支付安全:** Creem PCI DSS合规
- **敏感数据:** 环境变量隔离存储

### 访问控制矩阵
```
资源类型        匿名用户    已登录用户    管理员
────────────────────────────────────────────
公开页面          ✅          ✅          ✅
用户数据          ❌          ✅(own)     ✅
积分信息          ❌          ✅(own)     ✅  
购买记录          ❌          ✅(own)     ✅
视频生成          ❌          ✅          ✅
支付操作          ❌          ✅          ✅
系统管理          ❌          ❌          ✅
```

---

## 📊 数据流架构

### 用户注册登录流程
```
用户访问 → Clerk登录 → JWT生成 → 自动同步 → 数据库记录
   │          │           │          │           │
   ▼          ▼           ▼          ▼           ▼
 首次访问   Google认证   Token返回  /api/user/   User表
   │          │           │        /sync调用      创建
   ▼          ▼           ▼          │           │
 重定向    用户信息      客户端      ▼           ▼
   │       获取成功      存储Token  数据同步    积分初始化
   ▼          │           │          │        (8积分)
 dashboard   ▼           ▼          ▼           │
页面        个人信息    认证状态   用户记录      ▼
           展示        持久化     更新        数据库
                                            完成
```

### 购买积分流程
```
选择套餐 → Creem支付 → 支付完成 → Webhook → 积分分配
   │          │           │          │         │
   ▼          ▼           ▼          ▼         ▼
定价页面   支付页面    第三方支付   订单回调   数据库更新
   │          │           │          │         │
   ▼          ▼           ▼          ▼         ▼
产品选择   订单创建    银行/卡支付  订单验证   Purchase记录
   │          │           │          │         │
   ▼          ▼           ▼          ▼         ▼
Creem跳转  支付处理    支付成功    用户匹配   totalCredits
   │          │           │          │       增加
   ▼          ▼           ▼          ▼         │
外部网关   实时处理    返回平台    积分计算    ▼
   │          │           │          │       用户可用
   ▼          ▼           ▼          ▼       积分更新
自动回调   状态同步    成功页面    完成分配
```

### 视频生成流程  
```
用户输入 → 积分检查 → AI请求 → 生成处理 → 结果返回
   │          │         │        │          │
   ▼          ▼         ▼        ▼          ▼
提示词     余额验证   Veo3 API  视频生成   下载链接
输入        │         调用      队列处理    │
   │        ▼         │        │          ▼
   ▼     credits≥10   ▼        ▼        Video记录
前端表单   检查       API密钥   异步任务   数据库保存
   │        │        轮询使用   │          │
   ▼        ▼         │        ▼          ▼
验证通过   扣除积分    ▼       状态跟踪   usedCredits
   │        │       HTTP请求  │         增加10
   ▼        ▼         │        ▼          │
API调用   数据库      ▼       完成通知    ▼
         更新      Google AI   │        积分余额
           │       服务器      ▼        重新计算
           ▼         │       1080p
         积分记录    ▼       视频文件
         AuditLog   返回结果    │
                    │          ▼
                    ▼        用户下载
                  任务ID     使用
                  状态码
```

---

## 🔌 第三方集成架构

### 集成服务概览
```
CuttingASMR Platform
├── Clerk (认证服务)
│   ├── 用户注册/登录
│   ├── JWT Token管理  
│   ├── 会话状态维护
│   └── 用户信息同步
├── Creem (支付服务)
│   ├── 支付页面跳转
│   ├── 订单状态管理
│   ├── Webhook回调
│   └── 退款处理
├── Google Veo3 Fast (AI服务)
│   ├── 视频生成API
│   ├── 任务状态查询
│   ├── 结果文件获取
│   └── API密钥轮询
└── Railway (数据库服务)
    ├── PostgreSQL托管
    ├── 自动备份
    ├── 连接池管理
    └── 性能监控
```

### API集成策略
- **重试机制:** 指数退避 + 最大重试次数
- **熔断保护:** 失败阈值触发熔断
- **缓存策略:** 响应缓存 + TTL管理
- **监控告警:** 调用失败率 + 响应时间监控

---

## 📈 性能优化架构

### 前端性能优化
```
优化策略                   实现方案                    预期效果
──────────────────────────────────────────────────────────────
代码分割              Next.js动态导入              减少初始包大小
图片优化              Next.js Image组件           自动WebP转换
静态资源缓存           Cloudflare CDN             99%缓存命中率
预加载关键资源         Link prefetch               减少页面跳转延迟
CSS优化               TailwindCSS压缩             减少样式文件大小
```

### 后端性能优化
```
优化策略                   实现方案                    预期效果
──────────────────────────────────────────────────────────────
数据库连接池           Prisma连接管理              减少连接开销
查询优化              索引优化+查询计划            提升查询速度
API响应缓存           Edge Runtime缓存            减少重复计算
异步处理              视频生成任务队列              提升用户体验
负载均衡              API密钥轮询使用             分散服务压力
```

---

## 🔍 监控与观测架构

### 关键指标监控
```
业务指标
├── 用户注册转化率
├── 支付成功率  
├── 视频生成成功率
└── 用户留存率

技术指标
├── API响应时间
├── 数据库查询性能
├── CDN缓存命中率
└── 错误率统计

资源指标  
├── 数据库连接数
├── API调用频率
├── 存储空间使用
└── 带宽消耗
```

### 日志架构
- **应用日志:** 业务操作记录
- **访问日志:** 用户行为追踪  
- **错误日志:** 异常情况记录
- **审计日志:** 安全操作记录

---

## 🚧 扩展性设计

### 水平扩展策略
```
当前架构 (单实例)     →     扩展架构 (多实例)
─────────────────────────────────────────────────
Cloudflare Pages             负载均衡器
     │                           │
单一Edge Runtime          多个Edge Runtime
     │                           │
Railway PostgreSQL         分库分表 + 读写分离
     │                           │
单一Veo3密钥池            多AI服务商集成
```

### 功能扩展规划
- **多AI引擎:** 支持更多AI视频生成服务
- **内容管理:** 用户视频库管理系统
- **社交功能:** 视频分享与评论系统
- **订阅模式:** 月付年付订阅选项
- **API开放:** 第三方开发者API

---

## 📚 总结

CuttingASMR.org采用现代化的全栈架构，具备以下特点：

### 🎯 核心优势
1. **高可用性:** 99.9%+ 系统可用性保证
2. **全球化:** Cloudflare CDN确保全球访问速度
3. **安全可靠:** 多层安全防护 + 合规认证
4. **易维护:** 模块化设计 + 清晰的代码结构
5. **可扩展:** 支持业务增长的架构设计

### 🔧 技术特色
- **Edge Runtime:** 利用边缘计算提升性能
- **积分制:** 简化的商业模式 + 灵活的定价
- **AI集成:** 无缝对接Google Veo3服务
- **自动化:** 从支付到服务交付全自动化

这个架构为CuttingASMR.org提供了坚实的技术基础，支持未来的业务发展和技术演进。

---

*文档版本: v1.0*  
*最后更新: 2025-01-25*  
*维护团队: CuttingASMR技术团队* 